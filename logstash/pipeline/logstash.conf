#input {
#	beats {
#		port => 5044
#	}
#
#	tcp {
#		port => 50000
#	}
#}
#
### Add your filters / logstash plugins configuration here
#
#output {
#	elasticsearch {
#		hosts => "elasticsearch:9200"
#		user => "logstash_internal"
#		password => "${LOGSTASH_INTERNAL_PASSWORD}"
#	}
#}

# # 追加した部分
# input {
#   # file {
#   #   path => "/var/log/system.log"
#   #   start_position => "beginning"
#   #   sincedb_path => "/dev/null"
#   # }
#   exec {
#     command => "top -b -n 1 | head -10 | jq -rcsR '[ gsub("\n$";"") | splits("\n") | sub(" +$";"") | sub("^ +";"")] | .[0:5] as $titles | .[6:] as $data | {"sys": [$titles | .[] | split(",") | [.[] | sub("^ +";"")]]} as $sys |  [$data[0] | splits(" +") | sub("%";"") | sub("\\+";"")] as $row_keys | $data[1:] | [.[] | [splits(" +")]] | {"task":[.[] | [. as $r | range($row_keys|length) | {"key": $row_keys[.], "value": $r[.]}] | from_entries] | sort_by(.MEM) | reverse | .[:10]} as $task | $sys * $task' {"sys":[["top - 01:58:31 up  2:47","4 users","load average: 0.00","0.02","0.00"],["Tasks:  99 total","1 running","98 sleeping","0 stopped","0 zombie"],["Cpu(s):  2.0%us","0.9%sy","0.0%ni","96.4%id","0.5%wa","0.3%hi","0.0%si","0.0%st"],["Mem:    502040k total","379992k used","122048k free","44600k buffers"],["Swap:  1015804k total","0k used","1015804k free","258188k cached"]],"task":[{"PID":"1","USER":"root","PR":"20","NI":"0","VIRT":"19232","RES":"1376","SHR":"1100","S":"S","CPU":"0.0","MEM":"0.3","TIME":"0:00.41","COMMAND":"init"},{"PID":"3","USER":"root","PR":"RT","NI":"0","VIRT":"0","RES":"0","SHR":"0","S":"S","CPU":"0.0","MEM":"0.0","TIME":"0:00.00","COMMAND":"migration/0"},{"PID":"2","USER":"root","PR":"20","NI":"0","VIRT":"0","RES":"0","SHR":"0","S":"S","CPU":"0.0","MEM":"0.0","TIME":"0:00.00","COMMAND":"kthreadd"}]}"
#     interval => 10
#     type => "system_metrics"
#   }
# }

# output {
#   elasticsearch {
#     hosts => ["elasticsearch:9200"]
#     index => "mac-metrics-%{+YYYY.MM.dd}"
#     user => "elastic"  # Elasticsearchのユーザー名
#     password => "changeme"  # 環境変数からパスワードを取得
#   }
#   stdout { codec => rubydebug }
# }

input {
  exec {
    command => "top -b -n 1"
    interval => 10
    type => "metrics_test"
  }
}

filter {
  if [type] == "metrics_test" {
    grok {
      match => {
        "message" => [
          ".*load average: %{NUMBER:load1}, %{NUMBER:load5}, %{NUMBER:load15}.*",
          ".*Cpu\\(s\\): %{NUMBER:cpu_user}%%us, %{NUMBER:cpu_sys}%%sy, %{NUMBER:cpu_idle}%%id.*",
          ".*MiB Mem : %{NUMBER:total_mem} total, %{NUMBER:free_mem} free, %{NUMBER:used_mem} used, %{NUMBER:buff_cache_mem} buff/cache.*",
          ".*MiB Swap: %{NUMBER:total_swap} total, %{NUMBER:free_swap} free, %{NUMBER:used_swap} used. %{NUMBER:avail_mem} avail Mem.*"
        ]
      }
    }
    mutate {
      convert => {
        "load1" => "float"
        "load5" => "float"
        "load15" => "float"
        "cpu_user" => "float"
        "cpu_sys" => "float"
        "cpu_idle" => "float"
        "total_mem" => "float"
        "free_mem" => "float"
        "used_mem" => "float"
        "buff_cache_mem" => "float"
        "total_swap" => "float"
        "free_swap" => "float"
        "used_swap" => "float"
        "avail_mem" => "float"
      }
    }
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "system-metrics-%{+YYYY.MM.dd}"
    user => "elastic"
    password => "changeme"
  }
  stdout { codec => rubydebug }
}

# input {
#   exec {
#     command => "top -b -n 1"
#     interval => 10
#     type => "system_metrics"
#   }
# }

# filter {
#   if [type] == "system_metrics" {
#     grok {
#       match => {
#         "message" => [
#           ".*Load Avg: %{NUMBER:load1}, %{NUMBER:load5}, %{NUMBER:load15}.*CPU usage: %{NUMBER:cpu_user}%% user, %{NUMBER:cpu_sys}%% sys, %{NUMBER:cpu_idle}%% idle.*",
#           ".*PhysMem: %{NUMBER:physmem_used}M used.*",
#           ".*Networks: packets: %{NUMBER:net_in_packets}/%{NUMBER:net_in_bytes}G in, %{NUMBER:net_out_packets}/%{NUMBER:net_out_bytes}G out.*",
#           ".*Disks: %{NUMBER:disk_read_ops}/%{NUMBER:disk_read_bytes}T read, %{NUMBER:disk_write_ops}/%{NUMBER:disk_write_bytes}T written.*"
#         ]
#       }
#     }
#     mutate {
#       convert => {
#         "load1" => "float"
#         "load5" => "float"
#         "load15" => "float"
#         "cpu_user" => "float"
#         "cpu_sys" => "float"
#         "cpu_idle" => "float"
#         "physmem_used" => "float"
#         "net_in_packets" => "integer"
#         "net_in_bytes" => "float"
#         "net_out_packets" => "integer"
#         "net_out_bytes" => "float"
#         "disk_read_ops" => "integer"
#         "disk_read_bytes" => "float"
#         "disk_write_ops" => "integer"
#         "disk_write_bytes" => "float"
#       }
#     }
#   }
# }

# output {
#   elasticsearch {
#     hosts => ["http://elasticsearch:9200"]
#     index => "system-metrics-%{+YYYY.MM.dd}"
#     user => "elastic"
#     password => "changeme"
#   }
#   stdout { codec => rubydebug }
# }